<!DOCTYPE html>  <html> <head>   <title>core.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="AppMode.Error.html">                 AppMode.Error.coffee               </a>                                           <a class="source" href="AppMode.Welcome.html">                 AppMode.Welcome.coffee               </a>                                           <a class="source" href="DB.html">                 DB.coffee               </a>                                           <a class="source" href="Metadata.Basic.html">                 Metadata.Basic.coffee               </a>                                           <a class="source" href="Page.html">                 Page.coffee               </a>                                           <a class="source" href="core.html">                 core.coffee               </a>                                           <a class="source" href="sentinel.html">                 sentinel.coffee               </a>                                           <a class="source" href="utils.html">                 utils.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               core.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>*Provides the definition of <code>module</code> and the hooks and services implementation</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p><em>Note about terminology</em>: A component is a logical set of services (e.g. the
database or the title metadata stuff), while a module is a chunk of code (such
as a specific DB implementation or all basic metadata). Modules will at some
point be user-selectable.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h2>Hooks- and Services-based architecture</h2>

<p>There are two ways to pass messages between various components:</p>

<ul>
<li><strong>services</strong> -- I want you to do this (like public methods -- a specific
request to do something and possibly return a value), and</li>
<li><strong>hooks</strong> -- just FYI (aka announces -- just saying what happened, but not
caring what the others will do).</li>
</ul>

<p><strong>Modules are supposed to only care about themselves</strong>, i.e. there is no
direct way to access a different module -- one can only ask for a service, and
knows nothing about the specific provider.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">S = top.S = </span><span class="p">{}</span>
<span class="nx">do</span> <span class="o">-&gt;</span>
    <span class="nv">S.version = </span><span class="s">&#39;0.0&#39;</span>
    <span class="nv">S.debug = </span><span class="kc">true</span>
    <span class="nv">S.DBG = </span><span class="p">{}</span>

    <span class="nv">hooks = </span><span class="p">{}</span>
    <span class="nv">services = </span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>A module is a closure (i.e. a function). This function executes the module
module if it is enabled, and collects the names and descriptions
of all available modules so that the user can choose from them. It also
provides a way for modules to export things to their namespace (but this
should be used only for debugging). The exports object also contains the
module info, so that it can be easily referenced inside the module.</p>

<p>TODO This function will eventually check whether a module is enabled before it
runs the function
TODO something somewhere really should catch the conflict exception!</p>

<p>TODO fix the docs once we have the stuff</p>

<p>here come the docs from the previous version:
The hook callbacks will be called with one argument: the data supplied by
the sender, if any.</p>

<p>A hook name can also have the form "something:done". This will be run once
all hooks on "something" have finished executing -- therefore you can wait
for other modules to respond to something and then resume.</p>

<p>(Note: "something:done:done" etc will not be supported, that really
shouldn't be necessary.)</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">top.module = </span><span class="nf">(name, desc, module_fn) -&gt;</span> 
        <span class="nv">m = name: </span><span class="nx">name</span><span class="p">,</span> <span class="nv">desc: </span><span class="nx">desc</span>
        <span class="nx">module_fn</span> <span class="nx">m</span>
        <span class="nx">S</span><span class="p">.</span><span class="nx">say</span> <span class="s">&#39;ModuleAdded&#39;</span><span class="p">,</span> <span class="nx">m</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Runs a specified hook (passing all but the 1st argument to all registered
functions).</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">S.say = </span><span class="nf">(hookname, args...) -&gt;</span>
        <span class="nx">log</span> <span class="s">&quot;H :: Running: </span><span class="si">#{</span><span class="nx">hookname</span><span class="si">}</span><span class="s">&quot;</span> <span class="k">if</span> <span class="nx">S</span><span class="p">.</span><span class="nx">debug</span>
        <span class="k">if</span> <span class="nx">hooks</span><span class="p">[</span><span class="nx">hookname</span><span class="p">]</span><span class="o">?</span> <span class="k">then</span> <span class="nx">f</span><span class="p">.</span><span class="nx">apply</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">args</span> <span class="k">for</span> <span class="nx">f</span> <span class="k">in</span> <span class="nx">hooks</span><span class="p">[</span><span class="nx">hookname</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>we explicitly don't want to support this recursively</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">S</span><span class="p">.</span><span class="nx">say</span> <span class="nx">hookname</span> <span class="o">+</span> <span class="s">&#39;:done&#39;</span> <span class="nx">unless</span> <span class="nx">hookname</span><span class="p">.</span><span class="nx">match</span> <span class="sr">/:done$/</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Registers a function to execute when a specific hook is run</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">S.hookto = </span><span class="nf">(name, fn) -&gt;</span>
        <span class="nx">log</span> <span class="s">&quot;H :: Registered </span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">&quot;</span> <span class="k">if</span> <span class="nx">S</span><span class="p">.</span><span class="nx">debug</span>
        <span class="nx">hooks</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">?=</span> <span class="p">[]</span>
        <span class="nx">hooks</span><span class="p">[</span><span class="nx">name</span><span class="p">].</span><span class="nx">push</span> <span class="nx">fn</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Asks for a service. This function returns whatever the service returns; it
is synchronous.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">S.ask = </span><span class="nf">(interface) -&gt;</span>
        <span class="k">if</span> <span class="o">not</span> <span class="nx">services</span><span class="p">[</span><span class="nx">interface</span><span class="p">]</span><span class="o">?</span> <span class="k">then</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Service not implemented: </span><span class="si">#{</span><span class="nx">interface</span><span class="si">}</span><span class="s"> does not exist&quot;</span>
        <span class="nx">log</span> <span class="s">&quot;S :: Asked for: </span><span class="si">#{</span><span class="nx">interface</span><span class="si">}</span><span class="s">&quot;</span> <span class="k">if</span> <span class="nx">S</span><span class="p">.</span><span class="nx">debug</span>
        <span class="k">return</span> <span class="nx">services</span><span class="p">[</span><span class="nx">interface</span><span class="p">]</span>

    <span class="nv">S.provide = </span><span class="nf">(interface, impl) -&gt;</span>
        <span class="k">if</span> <span class="nx">services</span><span class="p">[</span><span class="nx">interface</span><span class="p">]</span><span class="o">?</span> <span class="k">then</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Service conflict: Service </span><span class="si">#{</span><span class="nx">interface</span><span class="si">}</span><span class="s"> provided more than once&quot;</span>
        <span class="nx">log</span> <span class="s">&quot;S :: Added </span><span class="si">#{</span><span class="nx">interface</span><span class="si">}</span><span class="s">&quot;</span> <span class="k">if</span> <span class="nx">S</span><span class="p">.</span><span class="nx">debug</span>
        <span class="nx">services</span><span class="p">[</span><span class="nx">interface</span><span class="p">]</span> <span class="o">=</span> <span class="nx">impl</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 