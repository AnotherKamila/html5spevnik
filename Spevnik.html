<!DOCTYPE html>  <html> <head>   <title>Spevnik.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="DB.html">                 DB.coffee               </a>                                           <a class="source" href="Sentinel.html">                 Sentinel.coffee               </a>                                           <a class="source" href="Spevnik.html">                 Spevnik.coffee               </a>                                           <a class="source" href="Utils.html">                 Utils.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               Spevnik.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>The really core stuff is defined here.</p>

<p>Provides Spevnik's event methods.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">module</span> <span class="s">&#39;S&#39;</span><span class="p">,</span> <span class="nf">(exports) -&gt;</span>
    <span class="nv">exports.version = </span><span class="s">&#39;0.0&#39;</span>

    <span class="nv">debug = </span><span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>We will have an event-based architecture. The core core core part is
basically just this fact. Here I define the methods for firing events and
attaching event handlers. All message-passing between modules will be done
using these.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Use this to attach event handlers to events. The callback will get a
single argument: the event object. It has a <code>data</code> property which contains
(a copy of) the object that the sender supplied, if any.</p>

<p>You can also attach to <code>someEvent:done</code>; this is fired once all processing
has finished on <code>someEvent</code>. (Example usage: You want other modules to
have their say, so you need to wait until they have finished talking and
then resume.)</p>

<p>TODO how to alter the data on event (probably: there is a method (like
<code>alter</code>) provided by the sender inside the data object, and the sender
manages what the others say to <code>alter</code>)</p>

<p><strong>Modules are supposed to be egocentric bastards that only care about
themselves</strong></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">exports.onEvent = </span><span class="nf">(type, callback) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>I am using the <code>document</code> object here rather than creating a custom one
and extending it with Mootools <code>Events</code>. The reason is that I need event
bubbling, see <code>fireEvent</code></p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">callback</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Use this to fire events that other modules can bind to. This is the
preferred way to pass messages between modules. Any relevant data attached
to that event should be passed as the second parameter.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">exports.fireEvent = </span><span class="nf">(type, data) -&gt;</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;Events: `</span><span class="si">#{</span><span class="nx">type</span><span class="si">}</span><span class="s">&#39; has fired&quot;</span> <span class="k">if</span> <span class="nx">debug</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Due to the nature of event bubbling, the event will get to <code>window</code>
only after all listeners on <code>document</code> have been fired (and finished
executing since JS is singlethreaded). Therefore once the event (and
control) gets here, we know all processing has finished and we can
tell the world about it.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">fireDoneEvent</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>now that the done listener is in place, the event can be fired</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">e = </span><span class="nx">doEvent</span> <span class="nx">type</span><span class="p">,</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">clone</span> <span class="nx">data</span>

    <span class="nv">fireDoneEvent = </span><span class="nf">(e) -&gt;</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;Events: `</span><span class="si">#{</span><span class="nx">e</span><span class="p">.</span><span class="nx">type</span><span class="si">}</span><span class="s">&#39; done processing&quot;</span> <span class="k">if</span> <span class="nx">debug</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>remove this listener, we're done here</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nb">window</span><span class="p">.</span><span class="nx">removeEventListener</span> <span class="nx">e</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="nx">fireDoneEvent</span><span class="p">,</span> <span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>fire :done event</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">doEvent</span> <span class="nx">e</span><span class="p">.</span><span class="nx">type</span> <span class="o">+</span> <span class="s">&#39;:done&#39;</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">data</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Takes the event name and data and fires the event.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">doEvent = </span><span class="nf">(type, data) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Uses the DOM2 API (MooTools does some weird stuff behind the scenes)</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>the events need to look like events in order to bubble</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">e = </span><span class="nb">document</span><span class="p">.</span><span class="nx">createEvent</span> <span class="s">&#39;Events&#39;</span>
        <span class="nx">e</span><span class="p">.</span><span class="nx">initEvent</span> <span class="nx">type</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">true</span>

        <span class="nv">e.data = </span><span class="nx">data</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>and finally throw it</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nb">document</span><span class="p">.</span><span class="nx">dispatchEvent</span> <span class="nx">e</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 