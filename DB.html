<!DOCTYPE html>  <html> <head>   <title>DB.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="DB.html">                 DB.coffee               </a>                                           <a class="source" href="Metadata.Test.html">                 Metadata.Test.coffee               </a>                                           <a class="source" href="core.html">                 core.coffee               </a>                                           <a class="source" href="sentinel.html">                 sentinel.coffee               </a>                                           <a class="source" href="utils.html">                 utils.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               DB.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>This module is responsible for handling the database. All transactions are
defined here.</p>

<h2>Structure</h2>

<p>Each object in the object store has a set of metadata properties, which are
indexed. (If a metadata property does not exist on an object, the object can
still be added to the database, but is invisible to that index.) Then there is
the <code>data</code> property, which is an object. It is not indexed. Inside <code>data</code>
there are fields for each data submodule (e.g. a submodule named <code>text</code> has
access to (only) <code>data['text']</code>). The insides of <code>data</code> are completely
uninteresting for <code>DB</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">S</span><span class="p">.</span><span class="nx">register</span> <span class="s">&#39;DB&#39;</span><span class="p">,</span> <span class="nf">(hooks) -&gt;</span>
    <span class="nv">debug = </span><span class="kc">true</span>

    <span class="nv">db = </span><span class="kc">null</span>

    <span class="nx">hooks</span><span class="p">[</span><span class="s">&#39;init&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>let the outside world tell us what they want in the DB</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">S</span><span class="p">.</span><span class="nx">run</span> <span class="s">&#39;DB.beforeSetup&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nv">addIndexField: </span><span class="nx">addIndexField</span> <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Initializes the DB</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">hooks</span><span class="p">[</span><span class="s">&#39;DB.beforeSetup:done&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-&gt;</span>
        <span class="nx">log</span> <span class="s">&#39;DB: Initialization started&#39;</span> <span class="k">if</span> <span class="nx">debug</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">indexedDB</span> <span class="o">or=</span> <span class="nx">webkitIndexedDB</span> <span class="o">or</span> <span class="nx">mozIndexedDB</span> <span class="o">or</span> <span class="nx">moz_indexedDB</span> <span class="c1"># TODO maybe make a separate file for stuff like this</span>

        <span class="nv">openReq = </span><span class="nx">indexedDB</span><span class="p">.</span><span class="nx">open</span> <span class="s">&#39;spevnik&#39;</span><span class="p">,</span> <span class="s">&#39;database for my pretty songbook&#39;</span>
        <span class="nv">openReq.onerror = </span><span class="nf">(e) -&gt;</span> <span class="nx">err</span> <span class="s">&#39;DB: Cannot open DB: &#39;</span> <span class="o">+</span> <span class="nx">e</span>

        <span class="nv">openReq.onsuccess = </span><span class="nf">(e) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>store the handle to the DB</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nv">db = </span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">result</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>DB events bubble, so this is my generic DB error handler (for now)</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nv">db.onerror = </span><span class="nf">(e) -&gt;</span> <span class="nx">err</span> <span class="s">&#39;DB: &#39;</span> <span class="o">+</span> <span class="nx">e</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p><code>db.version</code> is a description of what the database looks like
(i.e. what indices there are). In case this does not match (either
because version has never been set, or because new modules have
been added), we need to change the indices and update the version.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">log</span> <span class="s">&quot;DB: Current version: </span><span class="si">#{</span><span class="nx">db</span><span class="p">.</span><span class="nx">version</span><span class="si">}</span><span class="s">&quot;</span> <span class="k">if</span> <span class="nx">debug</span>
            <span class="nx">log</span> <span class="s">&quot;DB: Should be:       </span><span class="si">#{</span><span class="nx">getExpectedVersion</span><span class="p">()</span><span class="si">}</span><span class="s">&quot;</span> <span class="k">if</span> <span class="nx">debug</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>adds necessary indices on setVersion</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="nx">db</span><span class="p">.</span><span class="nx">version</span> <span class="o">!=</span> <span class="nx">getExpectedVersion</span><span class="p">()</span>
                <span class="nx">log</span> <span class="s">&#39;DB: initiating setVersion request...&#39;</span>
                <span class="nv">setVReq = </span><span class="nx">db</span><span class="p">.</span><span class="nx">setVersion</span> <span class="nx">getExpectedVersion</span><span class="p">()</span>
                <span class="nv">setVReq.onsuccess = </span><span class="nf">(e) -&gt;</span> <span class="c1"># Creates the necessary indices in a `setVersion` request</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>if the store exists, just get a handle, otherwise create it</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">if</span> <span class="nx">db</span><span class="p">.</span><span class="nx">objectStoreNames</span><span class="p">.</span><span class="nx">contains</span> <span class="s">&#39;songs&#39;</span>
                        <span class="nv">store = </span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">transaction</span><span class="p">.</span><span class="nx">objectStore</span> <span class="s">&#39;songs&#39;</span>
                    <span class="k">else</span>
                        <span class="nx">log</span> <span class="s">&#39;DB: Creating object store...&#39;</span> <span class="k">if</span> <span class="nx">debug</span>
                        <span class="nv">store = </span><span class="nx">db</span><span class="p">.</span><span class="nx">createObjectStore</span> <span class="s">&#39;songs&#39;</span><span class="p">,</span>
                                    <span class="p">{</span> <span class="nv">keyPath: </span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="nv">autoIncrement: </span><span class="kc">true</span> <span class="p">}</span>

                    <span class="k">for</span> <span class="nx">index</span> <span class="k">of</span> <span class="nx">indices</span>
                        <span class="nx">log</span> <span class="s">&quot;DB: Creating index for </span><span class="si">#{</span><span class="nx">index</span><span class="si">}</span><span class="s">&quot;</span> <span class="k">if</span> <span class="nx">debug</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>name and key path will be the same <br />
(TODO maybe specifying the options object should be possible)</p>             </td>             <td class="code">               <div class="highlight"><pre>                        <span class="nx">store</span><span class="p">.</span><span class="nx">createIndex</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="p">{</span> <span class="nv">unique: </span><span class="kc">false</span> <span class="p">}</span> <span class="c1"># TODO what happens if it already exists?</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>we're done</p>

<p>(TODO if I see funny bugs, it might be because <code>createIndex</code> might be
async actually)</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nx">S</span><span class="p">.</span><span class="nx">run</span> <span class="s">&#39;DB.ready&#39;</span>
            <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>otherwise we are done</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">S</span><span class="p">.</span><span class="nx">run</span> <span class="s">&#39;DB.ready&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <h3>addIndexFields (semi-public method)</h3>

<p>All modules that want to add metadata indices to the database need to use
this method. It is made available to them inside the <code>data</code> object for
the <code>DB.beforeSetup</code> event.</p>

<p>Pass a string: the future index name.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">addIndexField = </span><span class="nf">(f) -&gt;</span> <span class="nx">indices</span><span class="p">[</span><span class="nx">f</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>The <code>indices</code> object holds the future indices for the DB. It is populated
by the <code>addIndexFields</code> method. </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">indices = </span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <h3>getExpectedVersion (private helper)</h3>

<p>Generates the DB version based on the Spevnik version and active indices</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">getExpectedVersion = </span><span class="o">-&gt;</span> <span class="nx">S</span><span class="p">.</span><span class="nx">version</span><span class="o">+</span><span class="s">&#39;|&#39;</span><span class="o">+</span> <span class="p">(</span> <span class="nx">i</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">of</span> <span class="nx">indices</span> <span class="p">).</span><span class="nx">join</span> <span class="s">&#39;,&#39;</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 